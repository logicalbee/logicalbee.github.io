<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://logicalbee.github.io/favicon.svg><title>Handling concurrency in KeyValue stores | Sushanth Kurdekar</title><meta name=title content="Handling concurrency in KeyValue stores"><meta name=description content="Concurrency in golang using Locks"><meta name=keywords content><meta property="og:url" content="https://logicalbee.github.io/posts/key-value-concurrency/"><meta property="og:site_name" content="Sushanth Kurdekar"><meta property="og:title" content="Handling concurrency in KeyValue stores"><meta property="og:description" content="Concurrency in golang using Locks"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-10T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-10T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Handling concurrency in KeyValue stores"><meta name=twitter:description content="Concurrency in golang using Locks"><meta itemprop=name content="Handling concurrency in KeyValue stores"><meta itemprop=description content="Concurrency in golang using Locks"><meta itemprop=datePublished content="2023-12-10T00:00:00+00:00"><meta itemprop=dateModified content="2023-12-10T00:00:00+00:00"><meta itemprop=wordCount content="304"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--line-height:1.5;--spacing:1.5rem;--border-radius:8px;--shadow:0 2px 10px rgba(0, 0, 0, 0.1);--transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1)}[data-theme=light],:root{--background-color:#ffffff;--background-secondary:#f8f9fa;--heading-color:#1a202c;--text-color:#2d3748;--text-muted:#718096;--link-color:#3182ce;--link-hover:#2c5aa0;--visited-color:#805ad5;--border-color:#e2e8f0;--code-background:#1a202c;--code-color:#f7fafc;--code-inline-bg:#edf2f7;--code-inline-color:#e53e3e;--blockquote-bg:#edf2f7;--blockquote-border:#cbd5e0;--blockquote-color:#4a5568;--selection-bg:#bee3f8;--focus-ring:#3182ce}[data-theme=dark]{--background-color:#0f1419;--background-secondary:#1a202c;--heading-color:#f7fafc;--text-color:#e2e8f0;--text-muted:#a0aec0;--link-color:#63b3ed;--link-hover:#90cdf4;--visited-color:#b794f6;--border-color:#2d3748;--code-background:#1a202c;--code-color:#f7fafc;--code-inline-bg:#2d3748;--code-inline-color:#fbb6ce;--blockquote-bg:#1a202c;--blockquote-border:#4a5568;--blockquote-color:#cbd5e0;--selection-bg:#2d3748;--focus-ring:#63b3ed}*{box-sizing:border-box}::selection{background-color:var(--selection-bg)}body{font-family:var(--font-secondary);font-size:var(--font-scale);line-height:var(--line-height);margin:0;padding:var(--spacing);max-width:var(--width);margin-left:auto;margin-right:auto;background-color:var(--background-color);color:var(--text-color);word-wrap:break-word;overflow-wrap:break-word;transition:var(--transition);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);font-weight:700;color:var(--heading-color);line-height:1.3;margin-top:2em;margin-bottom:.5em;letter-spacing:-.025em}h1{font-size:2.5rem}h2{font-size:2rem}h3{font-size:1.5rem}h4{font-size:1.25rem}h5{font-size:1.125rem}h6{font-size:1rem}p{margin-bottom:var(--spacing);color:var(--text-color)}a{color:var(--link-color);text-decoration:none;transition:var(--transition);border-radius:2px}a:hover{color:var(--link-hover)}a:focus{outline:2px solid var(--focus-ring);outline-offset:2px}a:visited{color:var(--visited-color)}nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:calc(var(--spacing) * 2);padding-bottom:var(--spacing);border-bottom:1px solid var(--border-color);flex-wrap:wrap;gap:1rem;font-style:italic}nav .nav-links{display:flex;gap:1.5rem;align-items:center}nav a{font-weight:500;padding:.5rem 0}.theme-toggle{background:var(--background-secondary);border:1px solid var(--border-color);color:var(--text-color);padding:.5rem 1rem;border-radius:var(--border-radius);cursor:pointer;font-size:.875rem;font-weight:500;transition:var(--transition);display:flex;align-items:center;gap:.5rem}.theme-toggle:hover{background-color:var(--text-color);color:var(--background-color);transform:translateY(-1px)}main{margin-bottom:calc(var(--spacing) * 3)}code{font-family:var(--font-mono);font-size:.9em;font-weight:500;letter-spacing:.025em}:not(pre)>code{background-color:var(--code-inline-bg);color:var(--code-inline-color);padding:.2rem .4rem;border-radius:4px;font-weight:600;font-size:.85em}pre{background-color:var(--code-background);color:var(--code-color);padding:1.5rem;border-radius:var(--border-radius);overflow-x:auto;margin:var(--spacing)0;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,6%);border:1px solid var(--border-color);position:relative;font-size:1em;line-height:1.6}[data-theme=dark] pre{box-shadow:0 4px 6px -1px rgba(0,0,0,.3),0 2px 4px -1px rgba(0,0,0,.2)}pre code{background-color:transparent;color:inherit;padding:0;border-radius:0;font-size:.9em;font-weight:400;letter-spacing:inherit}pre[data-lang]::before{content:attr(data-lang);position:absolute;top:.5rem;right:1rem;font-size:.9rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;font-weight:600}blockquote{background-color:var(--blockquote-bg);border-left:4px solid var(--link-color);color:var(--blockquote-color);padding:1rem 1.5rem;margin:var(--spacing)0;border-radius:0 var(--border-radius)var(--border-radius)0;font-style:italic}blockquote p:last-child{margin-bottom:0}ul,ol{margin:var(--spacing)0;padding-left:2rem}li{margin-bottom:.5rem}table{width:100%;border-collapse:collapse;margin:var(--spacing)0;border-radius:var(--border-radius);overflow:hidden;box-shadow:var(--shadow)}th,td{padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--border-color)}th{background-color:var(--background-secondary);font-weight:600;color:var(--heading-color)}img{max-width:100%;height:auto;border-radius:var(--border-radius);margin:var(--spacing)0;box-shadow:0 10px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,4%);transition:var(--transition);border:1px solid var(--border-color)}[data-theme=dark] img{box-shadow:0 10px 25px -5px rgba(0,0,0,.4),0 10px 10px -5px rgba(0,0,0,.2);border-color:rgba(255,255,255,.1)}img:hover{transform:translateY(-2px);box-shadow:0 20px 40px -10px rgba(0,0,0,.15),0 10px 20px -5px rgba(0,0,0,8%)}[data-theme=dark] img:hover{box-shadow:0 20px 40px -10px rgba(0,0,0,.5),0 10px 20px -5px rgba(0,0,0,.3)}img+em,figure figcaption{display:block;text-align:center;font-style:italic;font-size:.875rem;color:var(--text-muted);margin-top:.5rem;margin-bottom:var(--spacing)}figure{margin:var(--spacing)0;text-align:center}figure img{margin-bottom:.5rem}hr{border:0;height:1px;background:var(--border-color);margin:calc(var(--spacing) * 2)0}button{font-family:inherit;cursor:pointer;border:none;border-radius:var(--border-radius);transition:var(--transition)}button:focus{outline:2px solid var(--focus-ring);outline-offset:2px}.title{margin-bottom:calc(var(--spacing) * 2)}.title:hover{text-decoration:none}.title h1{margin:0;font-size:2.5rem;background:linear-gradient( 135deg,var(--link-color),var(--visited-color) );background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent}.inline{width:auto !important}time{font-family:var(--font-mono);font-size:.875rem;color:var(--text-muted);font-weight:500}strong,b{color:var(--heading-color);font-weight:600}ul.blog-posts{list-style:none;padding:0;margin:calc(var(--spacing) * 2)0}ul.blog-posts li{display:flex;align-items:baseline;gap:1rem;padding:.75rem 0;border-bottom:1px solid var(--border-color);transition:var(--transition)}ul.blog-posts li:hover{background-color:var(--background-secondary);margin:0 -1rem;padding-left:1rem;padding-right:1rem;border-radius:var(--border-radius)}ul.blog-posts li:last-child{border-bottom:none}ul.blog-posts li time{flex-shrink:0;min-width:120px;font-size:.85rem}ul.blog-posts li a{font-weight:500;flex:1}ul.blog-posts li a:visited{color:var(--visited-color)}footer{padding:calc(var(--spacing) * 2)0;text-align:center;border-top:1px solid var(--border-color);color:var(--text-muted);font-size:.875rem}@media(max-width:768px){:root{--font-scale:1rem;--spacing:1rem;--width:100%}body{padding:1rem}h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.375rem}nav{flex-direction:column;align-items:stretch}nav .nav-links{justify-content:center}.theme-toggle{align-self:center}ul.blog-posts li{flex-direction:column;align-items:flex-start;gap:.25rem}ul.blog-posts li time{min-width:auto}pre{padding:1rem;margin-left:-1rem;margin-right:-1rem;border-radius:0}}@media print{body{background:#fff;color:#000;font-size:12pt;line-height:1.4}.theme-toggle{display:none}a{color:#000}pre{background:#f5f5f5;border:1px solid #ccc}}@media(prefers-reduced-motion:reduce){*{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}</style></head><body><header><a href=/ class=title><h2>Sushanth Kurdekar</h2></a><nav><a href=/>home</a>
<a href=/posts/>blog</a>
<a href=/projects/>projects</a>
<a href=/resume.pdf>resume</a>
<button class=theme-toggle aria-label="Switch to dark mode">🌙</button></nav></header><main><content><p>Key value stores might seem simple from outer view. We set and get the values which I thought the same. However, things get tricky as we dive deep. The problem is that, what happens if few processes write a key at the same time, and few processes read the same key.</p><p>We can actually simulate this using <code>goroutines</code> in golang.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>numGoRoutines</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span><span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>numGoRoutines</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>numGoRoutines</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>kv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nimbusdb</span>.<span style=color:#a6e22e>KeyValuePair</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Key</span>:   []byte(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%d&#34;</span>, <span style=color:#a6e22e>i</span>)),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Value</span>: []byte(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;testvalue%d&#34;</span>, <span style=color:#a6e22e>i</span>)),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>writtenKvPair</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>kv</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span></code></pre></div><p>The above code creates 1000 goroutines each setting a different value. But, the problem is that multiple go routines can touch the variable where the keyvalue pairs are stored. Why is that a problem? Because we want to be 100% sure that only one process is using the variable at a given moment, which you might have guessed that we&rsquo;ll use locks.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BTree</span>) <span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>value</span> <span style=color:#a6e22e>KeyDirValue</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>KeyDirValue</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>ReplaceOrInsert</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>item</span>{<span style=color:#a6e22e>key</span>: <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>v</span>: <span style=color:#a6e22e>value</span>})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>i</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>item</span>).<span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>b.mu</code> is of type <code>sync.RWMutex</code> meaning it has both shared and exclusive locks available. In the Set function above we use <code>.Lock()</code> which means it is a exclusive lock. Any other goroutine cannot access the region until we call <code>.Unlock()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BTree</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>key</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>KeyDirValue</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>item</span>{<span style=color:#a6e22e>key</span>: <span style=color:#a6e22e>key</span>})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>i</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>item</span>).<span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>However, in the <code>.Get()</code> function, we use <code>.RLock()</code> since we allow multiple process reading a value.</p><p>This command <code>go test ./tests -v --race</code> can be run to check for race conditions.</p><p>The above code is from a key-value store which I&rsquo;m writing from scratch. You can find it <a href=https://github.com/manosriram/nimbusdb>here</a></p></content><p></p></main><footer></footer><script>function toggleTheme(){const t=document.body,s=t.getAttribute("data-theme")||"light",e=s==="dark"?"light":"dark";t.setAttribute("data-theme",e),localStorage.setItem("theme",e);const n=document.querySelector(".theme-toggle");n&&(n.textContent=e==="dark"?"☀️":"🌙")}function initializeTheme(){const t=localStorage.getItem("theme")||"light";document.body.setAttribute("data-theme",t);const e=document.querySelector(".theme-toggle");e?(e.textContent=t==="dark"?"☀️":"🌙",e.addEventListener("click",toggleTheme)):setTimeout(initializeTheme,100)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initializeTheme):initializeTheme()</script></body></html>